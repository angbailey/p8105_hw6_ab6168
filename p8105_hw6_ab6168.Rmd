---
title: "Homework 6"
author: "Angelica Bailey"
date: "2025-11-26"
output: github_document
---

```{r,message=FALSE}
library(tidyverse)
library(modelr)
library(broom)
```

## Problem 1

Reading in data

```{r,message=FALSE}
homicide_data = read_csv("data/homicide-data.csv")
```

Data cleaning

```{r}
homicide_data = homicide_data |> 
  #creating city_state variable and binary variable for solved/unsolved homicides
  mutate(city_state = str_c(city, ", ", state), 
         homicide_solved = if_else(disposition == "Closed by arrest", 1, 0)    
         ) |> 
  #filtering states and race
  filter(!city_state %in% c("Dallas, TX",
                            "Phoenix, AZ",
                            "Kansas City, MO",
                            "Tulsa, AL"),
         victim_race %in% c("White", "Black")) |> 
  #victim age as numeric
  mutate(victim_age = suppressWarnings(as.numeric(victim_age)))
```

Fitting logistic regression for Baltimore, MD

```{r}
baltimore_data = homicide_data |> 
  filter(city_state == "Baltimore, MD")

baltimore_fit = glm(
  homicide_solved ~ victim_age + victim_sex + victim_race,
  data = baltimore_data,
  family = binomial(link = "logit")
)

# tidy model with adjusted odds ratio
tidy_fit = tidy(baltimore_fit, exponentiate = TRUE, conf.int = TRUE)

#extracting OR for victim sex
tidy_fit |> 
  filter(term == "victim_sexMale")
```

Iterating for all cities

```{r, warning=FALSE}
city_or_results = homicide_data |> 
  group_by(city_state) |> 
  nest() |> 
  #fitting logistic model for each city
  mutate(
    model = map(data, ~ glm(
      homicide_solved ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial
    )),
    #extracting OR
    results = map(model, ~ tidy(
      .x,
      exponentiate = TRUE,
      conf.int = TRUE
    ))
  ) |> 
  unnest(results) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, estimate, conf.low, conf.high)
```

Creating plot

```{r}
city_or_results = city_or_results |> 
  #reordering cities by OR
  mutate(city_state = fct_reorder(city_state, estimate))

ggplot(city_or_results, 
       aes(x = estimate, 
           y = city_state)) +
  geom_point(color = "darkgreen") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), color = "darkseagreen4", height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    title = "Adjusted Odds Ratios for Solving Homicides (Male vs Female Victims)",
    x = "Odds Ratio (Male vs Female)",
    y = "City"
  ) +
  theme_minimal(base_size = 12)
```

**Comments:**

The plot shows variation across cities in the adjusted odds ratio. In most cities, the odds ratios are below 1 indicating that homicides involving male victims are less likely to be solved than those involving female victims when adjusting for age and race. A few cities have an odds ratio closer to or above 1 showing an increase in odds for male victims. Some estimates have wide confidence intervals signifying uncertainty in the estimate.

## Problem 2

```{r,message=FALSE}
library(p8105.datasets)
data("weather_df")
```

Bootstrapping

```{r}
bootstrap_results = 
  weather_df |>
  modelr::bootstrap(5000) |>
  mutate(
    model = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    
    results = map(model, \(fit) {
      coefs = tidy(fit)
      tibble(
        r2 = glance(fit)$r.squared,
        ratio = coefs$estimate[coefs$term == "tmin"] /
          coefs$estimate[coefs$term == "prcp"]
      )
    })
  ) |>
  select(.id, results) |>
  unnest(results)

```

Plotting distribution of estimates

```{r}
#plot of r^2
bootstrap_results |>
  ggplot(aes(x = r2)) +
  geom_density(fill = "aquamarine3", alpha = 0.4) +
  theme_minimal() +
  labs(
    title = "Bootstrap Distribution of R-squared",
    x = "R-squared"
  )
```

**Comments:**

The bootstrap distribution of R^2^ is approximately unimodal, with most of the density concentrated between about 0.935 and 0.945. The shape is more symmetric and does not have heavy tails, showing that the estimate of R^2^ is stable across bootstrap samples. The variability across samples is small.

```{r}
#plot of beta1/beta2
bootstrap_results |>
  ggplot(aes(x = ratio)) +
  geom_density(fill = "coral3", alpha = 0.4) +
  theme_minimal() +
  labs(
    title = "Bootstrap Distribution of beta1 / beta2",
    x = "beta1 / beta2"
  )
```

**Comments:**

The bootstrap distribution of $\beta$ ~1~ **/**$\beta$ ~2~is wide and strongly left-skewed. This shows that the ratio of the `tmin` effect to the `prcp` effect varies across bootstrap samples. The coefficient for `prcp` is small so variations in $\beta$ ~2~ can cause the ratio to change greatly.



Computing 95% confidence intervals
```{r}
bootstrap_results |>
  pivot_longer(cols = c(r2, ratio), names_to = "term", values_to = "estimate") |>
  group_by(term) |>
  summarize(
    ci_lower = quantile(estimate, 0.025),
    ci_upper = quantile(estimate, 0.975)
  )
```


## Problem 3

```{r,message=FALSE}
bwt_data = read_csv("data/birthweight.csv")
```


Cleaning data
```{r}
bwt_data = bwt_data |>
  mutate(
    babysex = factor(babysex, labels = c("male", "female")),
    malform = factor(malform, labels = c("absent", "present")),
    frace = factor(frace,
                   labels = c("White", "Black", "Asian", "Puerto Rican", 
                              "Other")),
    mrace = factor(mrace,
                   labels = c("White", "Black", "Asian", "Puerto Rican")),
  ) |>
  drop_na()
```


Regression Model:
I'm starting a model based on hypothesized structure for the factors that underly birthweight. I'm including potential biological predictors. 
```{r}
model_bwt = 
  lm(bwt ~ bhead + blength + gaweeks + wtgain + smoken +
    momage + mheight + fincome + mrace,
  data = bwt_data
)
summary(model_bwt)
```

Adding predictions and residuals
```{r}
bwt_data = bwt_data |>
  add_predictions(model_bwt) |>
  add_residuals(model_bwt)
```


Plotting residuals vs. fitted
```{r}
bwt_data |>
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted Values",
    y = "Residuals"
  )
```












